using MediatR;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Moq;
using PeopleHub.API.Controllers.version1;
using PeopleHub.Application.DTOs;
using PeopleHub.Application.Features.People.Commands;
using PeopleHub.Application.Features.People.Queries;

namespace PeopleHub.Test.Controllers.Version1
{
    public class PeopleHubControllerV1Tests
    {
        private readonly Mock<IMediator> _mediatorMock;
        private readonly PeopleHubController _controller;

        public PeopleHubControllerV1Tests()
        {
            _mediatorMock = new Mock<IMediator>();
            _controller = new PeopleHubController(_mediatorMock.Object);
        }

        #region GetAll Tests

        [Fact]
        public async Task GetAll_ReturnsOkWithPeopleList()
        {
            // Arrange
            var expectedPeople = new List<PersonDtoV1>
            {
                new PersonDtoV1 
                { 
                    Id = 1, 
                    Nome = "João Silva", 
                    CPF = "12345678901",
                    DataNascimento = new DateTime(1990, 5, 15)
                },
                new PersonDtoV1 
                { 
                    Id = 2, 
                    Nome = "Maria Santos", 
                    CPF = "98765432109",
                    DataNascimento = new DateTime(1985, 3, 22)
                }
            };

            _mediatorMock
                .Setup(m => m.Send(It.IsAny<GetAllPeopleQuery>(), It.IsAny<CancellationToken>()))
                .ReturnsAsync(expectedPeople);

            // Act
            var result = await _controller.GetAll();

            // Assert
            var okResult = Assert.IsType<OkObjectResult>(result.Result);
            var returnValue = Assert.IsAssignableFrom<IEnumerable<PersonDtoV1>>(okResult.Value);
            Assert.Equal(2, returnValue.Count());
        }

        [Fact]
        public async Task GetAll_WithException_ReturnsInternalServerError()
        {
            // Arrange
            _mediatorMock
                .Setup(m => m.Send(It.IsAny<GetAllPeopleQuery>(), It.IsAny<CancellationToken>()))
                .ThrowsAsync(new Exception("Database connection failed"));

            // Act
            var result = await _controller.GetAll();

            // Assert
            var statusCodeResult = Assert.IsType<ObjectResult>(result.Result);
            Assert.Equal(StatusCodes.Status500InternalServerError, statusCodeResult.StatusCode);
        }

        #endregion

        #region GetById Tests

        [Fact]
        public async Task GetById_WithExistingId_ReturnsOkWithPerson()
        {
            // Arrange
            var personId = 1;
            var expectedPerson = new PersonDtoV1
            {
                Id = personId,
                Nome = "João Silva",
                CPF = "12345678901",
                DataNascimento = new DateTime(1990, 5, 15),
                Email = "joao@email.com"
            };

            _mediatorMock
                .Setup(m => m.Send(It.Is<GetPersonByIdQuery>(q => q.Id == personId), It.IsAny<CancellationToken>()))
                .ReturnsAsync(expectedPerson);

            // Act
            var result = await _controller.GetById(personId);

            // Assert
            var okResult = Assert.IsType<OkObjectResult>(result.Result);
            var returnValue = Assert.IsType<PersonDtoV1>(okResult.Value);
            Assert.Equal(expectedPerson.Id, returnValue.Id);
            Assert.Equal(expectedPerson.Nome, returnValue.Nome);
            Assert.Equal(expectedPerson.CPF, returnValue.CPF);
        }

        [Fact]
        public async Task GetById_WithNonExistingId_ReturnsNotFound()
        {
            // Arrange
            var personId = 999;

            _mediatorMock
                .Setup(m => m.Send(It.Is<GetPersonByIdQuery>(q => q.Id == personId), It.IsAny<CancellationToken>()))
                .ReturnsAsync((PersonDtoV1?)null);

            // Act
            var result = await _controller.GetById(personId);

            // Assert
            var notFoundResult = Assert.IsType<NotFoundObjectResult>(result.Result);
            Assert.NotNull(notFoundResult.Value);
        }

        [Fact]
        public async Task GetById_WithException_ReturnsInternalServerError()
        {
            // Arrange
            var personId = 1;

            _mediatorMock
                .Setup(m => m.Send(It.Is<GetPersonByIdQuery>(q => q.Id == personId), It.IsAny<CancellationToken>()))
                .ThrowsAsync(new Exception("Database connection failed"));

            // Act
            var result = await _controller.GetById(personId);

            // Assert
            var statusCodeResult = Assert.IsType<ObjectResult>(result.Result);
            Assert.Equal(StatusCodes.Status500InternalServerError, statusCodeResult.StatusCode);
        }

        #endregion

        #region Create Tests

        [Fact]
        public async Task Create_WithValidData_ReturnsCreated()
        {
            // Arrange
            var personDto = new PersonDtoV1
            {
                Nome = "João Silva",
                Sexo = "M",
                Email = "joao@email.com",
                DataNascimento = new DateTime(1990, 5, 15),
                Naturalidade = "São Paulo",
                Nacionalidade = "Brasileira",
                CPF = "12345678901"
            };

            var expectedResult = new PersonDtoV1
            {
                Id = 1,
                Nome = personDto.Nome,
                Sexo = personDto.Sexo,
                Email = personDto.Email,
                DataNascimento = personDto.DataNascimento,
                Naturalidade = personDto.Naturalidade,
                Nacionalidade = personDto.Nacionalidade,
                CPF = personDto.CPF
            };

            _mediatorMock
                .Setup(m => m.Send(It.IsAny<CreatePersonCommand>(), It.IsAny<CancellationToken>()))
                .ReturnsAsync(expectedResult);

            // Act
            var result = await _controller.Create(personDto);

            // Assert
            var createdResult = Assert.IsType<CreatedAtActionResult>(result.Result);
            var returnValue = Assert.IsType<PersonDtoV1>(createdResult.Value);
            Assert.Equal(expectedResult.Id, returnValue.Id);
            Assert.Equal(expectedResult.Nome, returnValue.Nome);
            Assert.Equal(expectedResult.CPF, returnValue.CPF);
            Assert.Equal("GetById", createdResult.ActionName);
        }

        [Fact]
        public async Task Create_WithInvalidCPF_ReturnsBadRequest()
        {
            // Arrange
            var personDto = new PersonDtoV1
            {
                Nome = "João Silva",
                CPF = "invalid_cpf",
                DataNascimento = new DateTime(1990, 5, 15)
            };

            _mediatorMock
                .Setup(m => m.Send(It.IsAny<CreatePersonCommand>(), It.IsAny<CancellationToken>()))
                .ThrowsAsync(new ArgumentException("CPF inválido"));

            // Act
            var result = await _controller.Create(personDto);

            // Assert
            var badRequestResult = Assert.IsType<BadRequestObjectResult>(result.Result);
            Assert.NotNull(badRequestResult.Value);
        }

        [Fact]
        public async Task Create_WithException_ReturnsInternalServerError()
        {
            // Arrange
            var personDto = new PersonDtoV1
            {
                Nome = "João Silva",
                CPF = "12345678901",
                DataNascimento = new DateTime(1990, 5, 15)
            };

            _mediatorMock
                .Setup(m => m.Send(It.IsAny<CreatePersonCommand>(), It.IsAny<CancellationToken>()))
                .ThrowsAsync(new Exception("Database connection failed"));

            // Act
            var result = await _controller.Create(personDto);

            // Assert
            var statusCodeResult = Assert.IsType<ObjectResult>(result.Result);
            Assert.Equal(StatusCodes.Status500InternalServerError, statusCodeResult.StatusCode);
        }

        #endregion

        #region Update Tests

        [Fact]
        public async Task Update_WithValidData_ReturnsOk()
        {
            // Arrange
            var personId = 1;
            var personDto = new PersonDtoV1
            {
                Nome = "João Silva Updated",
                Sexo = "M",
                Email = "joao.updated@email.com",
                DataNascimento = new DateTime(1990, 5, 15),
                Naturalidade = "São Paulo",
                Nacionalidade = "Brasileira",
                CPF = "12345678901"
            };

            var expectedResult = new PersonDtoV1
            {
                Id = personId,
                Nome = personDto.Nome,
                Sexo = personDto.Sexo,
                Email = personDto.Email,
                DataNascimento = personDto.DataNascimento,
                Naturalidade = personDto.Naturalidade,
                Nacionalidade = personDto.Nacionalidade,
                CPF = personDto.CPF
            };

            _mediatorMock
                .Setup(m => m.Send(It.IsAny<UpdatePersonCommand>(), It.IsAny<CancellationToken>()))
                .ReturnsAsync(expectedResult);

            // Act
            var result = await _controller.Update(personId, personDto);

            // Assert
            var okResult = Assert.IsType<OkObjectResult>(result.Result);
            var returnValue = Assert.IsType<PersonDtoV1>(okResult.Value);
            Assert.Equal(expectedResult.Id, returnValue.Id);
            Assert.Equal(expectedResult.Nome, returnValue.Nome);
        }

        [Fact]
        public async Task Update_WithInvalidData_ReturnsBadRequest()
        {
            // Arrange
            var personId = 1;
            var personDto = new PersonDtoV1
            {
                Nome = "João Silva",
                CPF = "invalid_cpf",
                DataNascimento = new DateTime(1990, 5, 15)
            };

            _mediatorMock
                .Setup(m => m.Send(It.IsAny<UpdatePersonCommand>(), It.IsAny<CancellationToken>()))
                .ThrowsAsync(new ArgumentException("CPF inválido"));

            // Act
            var result = await _controller.Update(personId, personDto);

            // Assert
            var badRequestResult = Assert.IsType<BadRequestObjectResult>(result.Result);
            Assert.NotNull(badRequestResult.Value);
        }

        #endregion

        #region Delete Tests

        [Fact]
        public async Task Delete_WithExistingId_ReturnsNoContent()
        {
            // Arrange
            var personId = 1;

            _mediatorMock
                .Setup(m => m.Send(It.Is<DeletePersonCommand>(c => c.Id == personId), It.IsAny<CancellationToken>()))
                .ReturnsAsync(true);

            // Act
            var result = await _controller.Delete(personId);

            // Assert
            Assert.IsType<NoContentResult>(result);
        }

        [Fact]
        public async Task Delete_WithNonExistingId_ReturnsNotFound()
        {
            // Arrange
            var personId = 999;

            _mediatorMock
                .Setup(m => m.Send(It.Is<DeletePersonCommand>(c => c.Id == personId), It.IsAny<CancellationToken>()))
                .ReturnsAsync(false);

            // Act
            var result = await _controller.Delete(personId);

            // Assert
            var notFoundResult = Assert.IsType<NotFoundObjectResult>(result);
            Assert.NotNull(notFoundResult.Value);
        }

        [Fact]
        public async Task Delete_WithException_ReturnsInternalServerError()
        {
            // Arrange
            var personId = 1;

            _mediatorMock
                .Setup(m => m.Send(It.Is<DeletePersonCommand>(c => c.Id == personId), It.IsAny<CancellationToken>()))
                .ThrowsAsync(new Exception("Database connection failed"));

            // Act
            var result = await _controller.Delete(personId);

            // Assert
            var statusCodeResult = Assert.IsType<ObjectResult>(result);
            Assert.Equal(StatusCodes.Status500InternalServerError, statusCodeResult.StatusCode);
        }

        #endregion

        #region Constructor Tests

        [Fact]
        public void Constructor_WithValidMediator_CreatesInstance()
        {
            // Arrange & Act
            var controller = new PeopleHubController(_mediatorMock.Object);

            // Assert
            Assert.NotNull(controller);
        }

        #endregion
    }
}